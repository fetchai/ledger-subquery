{"version":3,"file":"poi.service.js","sourceRoot":"","sources":["../../src/indexer/poi.service.ts"],"names":[],"mappings":";AAAA,gEAAgE;AAChE,sCAAsC;;;;;;;;;;;;AAEtC,2CAAmE;AACnE,yCAA0C;AAC1C,yCAAsC;AACtC,wDAAqD;AACrD,kEAA+D;AAC/D,sDAA0E;AAE1E,MAAM,mBAAmB,GAAG,IAAA,eAAQ,EAAC,MAAM,CAAC,CAAC;AAG7C,IAAa,UAAU,GAAvB,MAAa,UAAU;IAMrB,YACY,UAAsB,EACtB,OAAwB,EACxB,SAAoB;QAFpB,eAAU,GAAV,UAAU,CAAY;QACtB,YAAO,GAAP,OAAO,CAAiB;QACxB,cAAS,GAAT,SAAS,CAAW;QARxB,eAAU,GAAG,KAAK,CAAC;IASxB,CAAC;IAEJ,qBAAqB;QACnB,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC;IACzB,CAAC;IAED,KAAK,CAAC,IAAI,CAAC,MAAc;QACvB,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,OAAO,GAAG,IAAA,uBAAU,EAAC,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;QACvD,IAAI,CAAC,kBAAkB,GAAG,MAAM,IAAI,CAAC,qBAAqB,EAAE,CAAC;IAC/D,CAAC;IAED,KAAK,CAAC,uBAAuB;QAC3B,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC;YACzC,KAAK,EAAE,CAAC,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC;SACxB,CAAC,CAAC;QACH,IAAI,OAAO,KAAK,IAAI,IAAI,OAAO,KAAK,SAAS,EAAE;YAC7C,OAAO,IAAI,CAAC;SACb;aAAM,IAAI,OAAO,KAAK,IAAI,IAAI,OAAO,CAAC,IAAI,EAAE;YAC3C,OAAO,OAAO,CAAC,IAAI,CAAC;SACrB;aAAM;YACL,MAAM,IAAI,KAAK,CAAC,uCAAuC,CAAC,CAAC;SAC1D;IACH,CAAC;IAED,KAAK,CAAC,qBAAqB;QACzB,IAAI,CAAC,IAAI,CAAC,kBAAkB,EAAE;YAC5B,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,uBAAuB,EAAE,CAAC;YAC1D,IAAI,YAAY,KAAK,IAAI,IAAI,YAAY,KAAK,SAAS,EAAE;gBACvD,IAAI,CAAC,kBAAkB,GAAG,mBAAmB,CAAC;aAC/C;iBAAM;gBACL,IAAI,CAAC,kBAAkB,GAAG,YAAY,CAAC;aACxC;SACF;QACD,OAAO,IAAI,CAAC,kBAAkB,CAAC;IACjC,CAAC;IAED,qBAAqB,CAAC,IAAgB;QACpC,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC;IACjC,CAAC;CACF,CAAA;AAlDY,UAAU;IADtB,IAAA,mBAAU,GAAE;qCAQa,uBAAU;QACb,iCAAe;QACb,qBAAS;GATrB,UAAU,CAkDtB;AAlDY,gCAAU","sourcesContent":["// Copyright 2020-2022 OnFinality Limited authors & contributors\n// SPDX-License-Identifier: Apache-2.0\n\nimport { Injectable, OnApplicationShutdown } from '@nestjs/common';\nimport { hexToU8a } from '@polkadot/util';\nimport { Sequelize } from 'sequelize';\nimport { NodeConfig } from '../configure/NodeConfig';\nimport { SubqueryProject } from '../configure/SubqueryProject';\nimport { PoiFactory, PoiRepo, ProofOfIndex } from './entities/Poi.entity';\n\nconst DEFAULT_PARENT_HASH = hexToU8a('0x00');\n\n@Injectable()\nexport class PoiService implements OnApplicationShutdown {\n  private isShutdown = false;\n  private latestPoiBlockHash: Uint8Array;\n  private poiRepo: PoiRepo;\n  private schema: string;\n\n  constructor(\n    protected nodeConfig: NodeConfig,\n    protected project: SubqueryProject,\n    protected sequelize: Sequelize,\n  ) {}\n\n  onApplicationShutdown(): void {\n    this.isShutdown = true;\n  }\n\n  async init(schema: string): Promise<void> {\n    this.schema = schema;\n    this.poiRepo = PoiFactory(this.sequelize, this.schema);\n    this.latestPoiBlockHash = await this.getLatestPoiBlockHash();\n  }\n\n  async fetchPoiBlockHashFromDb(): Promise<Uint8Array | null> {\n    const lastPoi = await this.poiRepo.findOne({\n      order: [['id', 'DESC']],\n    });\n    if (lastPoi === null || lastPoi === undefined) {\n      return null;\n    } else if (lastPoi !== null && lastPoi.hash) {\n      return lastPoi.hash;\n    } else {\n      throw new Error(`Poi found but can not get latest hash`);\n    }\n  }\n\n  async getLatestPoiBlockHash(): Promise<Uint8Array | null> {\n    if (!this.latestPoiBlockHash) {\n      const poiBlockHash = await this.fetchPoiBlockHashFromDb();\n      if (poiBlockHash === null || poiBlockHash === undefined) {\n        this.latestPoiBlockHash = DEFAULT_PARENT_HASH;\n      } else {\n        this.latestPoiBlockHash = poiBlockHash;\n      }\n    }\n    return this.latestPoiBlockHash;\n  }\n\n  setLatestPoiBlockHash(hash: Uint8Array): void {\n    this.latestPoiBlockHash = hash;\n  }\n}\n"]}