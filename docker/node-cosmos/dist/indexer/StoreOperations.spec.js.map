{"version":3,"file":"StoreOperations.spec.js","sourceRoot":"","sources":["../../src/indexer/StoreOperations.spec.ts"],"names":[],"mappings":";AAAA,gEAAgE;AAChE,sCAAsC;;AAEtC,yCAA0C;AAE1C,uDAAoD;AACpD,mCAAwC;AAExC,MAAM,cAAc,GAAG;IACrB;QACE,SAAS,EAAE,qBAAa,CAAC,GAAG;QAC5B,UAAU,EAAE,eAAe;QAC3B,IAAI,EAAE;YACJ,EAAE,EAAE,oEAAoE;YACxE,MAAM,EAAE,KAAK;SACd;KACF;IACD;QACE,SAAS,EAAE,qBAAa,CAAC,GAAG;QAC5B,UAAU,EAAE,eAAe;QAC3B,IAAI,EAAE;YACJ,EAAE,EAAE,oEAAoE;YACxE,MAAM,EAAE,IAAI;YACZ,MAAM,EAAE,KAAK;YACb,MAAM,EAAE,IAAI;YACZ,MAAM,EAAE,IAAI,IAAI,CAAC,0BAA0B,CAAC;YAC5C,MAAM,EAAE,IAAI;YACZ,SAAS,EAAE,IAAI,IAAI,CAAC,0BAA0B,CAAC;YAC/C,SAAS,EAAE,IAAI,IAAI,CAAC,0BAA0B,CAAC;SAChD;KACF;IACD;QACE,SAAS,EAAE,qBAAa,CAAC,GAAG;QAC5B,UAAU,EAAE,eAAe;QAC3B,IAAI,EAAE;YACJ,EAAE,EAAE,oEAAoE;YACxE,MAAM,EAAE,IAAI;YACZ,MAAM,EAAE,KAAK;YACb,MAAM,EAAE,IAAI;YACZ,MAAM,EAAE,IAAI,IAAI,CAAC,0BAA0B,CAAC;YAC5C,MAAM,EAAE,IAAI;YACZ,SAAS,EAAE,IAAI,IAAI,CAAC,0BAA0B,CAAC;YAC/C,SAAS,EAAE,IAAI,IAAI,CAAC,0BAA0B,CAAC;SAChD;KACF;IACD;QACE,SAAS,EAAE,qBAAa,CAAC,GAAG;QAC5B,UAAU,EAAE,eAAe;QAC3B,IAAI,EAAE;YACJ,EAAE,EAAE,oEAAoE;YACxE,MAAM,EAAE,IAAI;YACZ,MAAM,EAAE,KAAK;YACb,MAAM,EAAE,IAAI;YACZ,MAAM,EAAE,IAAI,IAAI,CAAC,0BAA0B,CAAC;YAC5C,MAAM,EAAE,IAAI;YACZ,MAAM,EAAE,EAAE,IAAI,EAAE,CAAC,EAAE,KAAK,EAAE,EAAE,KAAK,EAAE,OAAO,EAAE,EAAE;YAC9C,SAAS,EAAE,IAAI,IAAI,CAAC,0BAA0B,CAAC;YAC/C,SAAS,EAAE,IAAI,IAAI,CAAC,0BAA0B,CAAC;YAC/C,MAAM,EAAE,UAAU,CAAC,MAAM,CAAC;YAC1B,MAAM,EAAE,KAAK;SACd;KACF;IACD;QACE,SAAS,EAAE,qBAAa,CAAC,MAAM;QAC/B,UAAU,EAAE,eAAe;QAC3B,IAAI,EAAE,oEAAoE;KAC3E;CACF,CAAC;AAEF,MAAM,cAAc,GAAG;IACrB,SAAS,EAAE,qBAAa,CAAC,MAAM;IAC/B,UAAU,EAAE,eAAe;IAC3B,IAAI,EAAE;QACJ,EAAE,EAAE,oEAAoE;QACxE,MAAM,EAAE,IAAI;QACZ,MAAM,EAAE,KAAK;QACb,MAAM,EAAE,IAAI;QACZ,MAAM,EAAE,IAAI,IAAI,CAAC,0BAA0B,CAAC;QAC5C,MAAM,EAAE,IAAI;QACZ,MAAM,EAAE,EAAE,IAAI,EAAE,CAAC,EAAE,KAAK,EAAE,EAAE,KAAK,EAAE,OAAO,EAAE,EAAE;QAC9C,SAAS,EAAE,IAAI,IAAI,CAAC,0BAA0B,CAAC;QAC/C,SAAS,EAAE,IAAI,IAAI,CAAC,0BAA0B,CAAC;QAC/C,MAAM,EAAE,UAAU,CAAC,MAAM,CAAC;KAC3B;CACF,CAAC;AACF,MAAM,KAAK,GAAyB;IAClC,IAAI,EAAE,OAAO;IACb,IAAI,EAAE,QAAQ;IACd,QAAQ,EAAE,IAAI;IACd,OAAO,EAAE,KAAK;CACf,CAAC;AACF,MAAM,SAAS,GAAyB;IACtC,IAAI,EAAE,OAAO;IACb,IAAI,EAAE,MAAM;IACZ,aAAa,EAAE,EAAE,IAAI,EAAE,OAAO,EAAE,MAAM,EAAE,CAAC,KAAK,CAAC,EAAE;IACjD,OAAO,EAAE,KAAK;IACd,QAAQ,EAAE,IAAI;CACf,CAAC;AACF,MAAM,QAAQ,GAAyB;IACrC,IAAI,EAAE,MAAM;IACZ,IAAI,EAAE,KAAK;IACX,QAAQ,EAAE,IAAI;IACd,OAAO,EAAE,KAAK;CACf,CAAC;AACF,MAAM,MAAM,GAAG;IACb;QACE,IAAI,EAAE,eAAe;QACrB,MAAM,EAAE;YACN;gBACE,IAAI,EAAE,IAAI;gBACV,IAAI,EAAE,IAAI;gBACV,OAAO,EAAE,KAAK;gBACd,QAAQ,EAAE,KAAK;gBACf,MAAM,EAAE,KAAK;aACd;YACD;gBACE,IAAI,EAAE,QAAQ;gBACd,IAAI,EAAE,KAAK;gBACX,OAAO,EAAE,KAAK;gBACd,QAAQ,EAAE,KAAK;gBACf,MAAM,EAAE,KAAK;aACd;YACD;gBACE,IAAI,EAAE,QAAQ;gBACd,IAAI,EAAE,QAAQ;gBACd,OAAO,EAAE,KAAK;gBACd,QAAQ,EAAE,IAAI;gBACd,MAAM,EAAE,KAAK;aACd;YACD;gBACE,IAAI,EAAE,QAAQ;gBACd,IAAI,EAAE,QAAQ;gBACd,OAAO,EAAE,KAAK;gBACd,QAAQ,EAAE,IAAI;gBACd,MAAM,EAAE,KAAK;aACd;YACD;gBACE,IAAI,EAAE,QAAQ;gBACd,IAAI,EAAE,MAAM;gBACZ,OAAO,EAAE,KAAK;gBACd,QAAQ,EAAE,IAAI;gBACd,MAAM,EAAE,KAAK;aACd;YACD;gBACE,IAAI,EAAE,QAAQ;gBACd,IAAI,EAAE,SAAS;gBACf,OAAO,EAAE,KAAK;gBACd,QAAQ,EAAE,IAAI;gBACd,MAAM,EAAE,KAAK;aACd;YACD;gBACE,IAAI,EAAE,QAAQ;gBACd,IAAI,EAAE,MAAM;gBACZ,aAAa,EAAE,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,CAAC,QAAQ,EAAE,SAAS,CAAC,EAAE;gBAC9D,OAAO,EAAE,KAAK;gBACd,QAAQ,EAAE,IAAI;gBACd,MAAM,EAAE,KAAK;aACd;YACD;gBACE,IAAI,EAAE,QAAQ;gBACd,IAAI,EAAE,OAAO;gBACb,OAAO,EAAE,KAAK;gBACd,QAAQ,EAAE,IAAI;gBACd,MAAM,EAAE,KAAK;aACd;YACD;gBACE,IAAI,EAAE,UAAU;gBAChB,WAAW,EAAE,mBAAmB;gBAChC,MAAM,EAAE,IAAI;gBACZ,OAAO,EAAE,KAAK;gBACd,QAAQ,EAAE,KAAK;gBACf,IAAI,EAAE,QAAQ;aACf;SACF;QACD,OAAO,EAAE,EAAE;KACZ;CACF,CAAC;AAEF,QAAQ,CAAC,iBAAiB,EAAE,GAAG,EAAE;IAC/B,EAAE,CAAC,kFAAkF,EAAE,GAAG,EAAE;QAC1F,MAAM,cAAc,GAAG,IAAI,iCAAe,CAAC,MAAM,CAAC,CAAC;QACnD,KAAK,MAAM,CAAC,IAAI,cAAc,EAAE;YAC9B,cAAc,CAAC,GAAG,CAAC,CAAC,CAAC,SAAS,EAAE,CAAC,CAAC,UAAU,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC;SACvD;QAED,cAAc,CAAC,uBAAuB,EAAE,CAAC;QACzC,MAAM,CAAC,cAAc,CAAC,qBAAqB,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QACvD,OAAO,CAAC,GAAG,CACT,gBAAgB,IAAA,eAAQ,EAAC,cAAc,CAAC,sBAAsB,EAAE,CAAC,EAAE,CACpE,CAAC;QACF,cAAc,CAAC,KAAK,EAAE,CAAC;QACvB,MAAM,CAAC,cAAc,CAAC,qBAAqB,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;IACzD,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,iDAAiD,EAAE,GAAG,EAAE;QACzD,MAAM,cAAc,GAAG,IAAI,iCAAe,CAAC,MAAM,CAAC,CAAC;QAEnD,MAAM,CAAC,GAAG,EAAE,CACV,cAAc,CAAC,GAAG,CAChB,cAAc,CAAC,SAAS,EACxB,cAAc,CAAC,UAAU,EACzB,cAAc,CAAC,IAAI,CACpB,CACF,CAAC,OAAO,CAAC,kDAAkD,CAAC,CAAC;IAChE,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","sourcesContent":["// Copyright 2020-2022 OnFinality Limited authors & contributors\n// SPDX-License-Identifier: Apache-2.0\n\nimport { u8aToHex } from '@polkadot/util';\nimport { GraphQLJsonFieldType } from '@subql/utils';\nimport { StoreOperations } from './StoreOperations';\nimport { OperationType } from './types';\n\nconst testOperations = [\n  {\n    operation: OperationType.Set,\n    entityType: 'StarterEntity',\n    data: {\n      id: '0x2494bd5d089cf370c366351e851755ee42e8477df1c17ea1d9c2ae94e4f77ea8',\n      field1: 41914,\n    },\n  },\n  {\n    operation: OperationType.Set,\n    entityType: 'StarterEntity',\n    data: {\n      id: '0x2494bd5d089cf370c366351e851755ee42e8477df1c17ea1d9c2ae94e4f77ea8',\n      field3: null,\n      field1: 41914,\n      field2: null,\n      field4: new Date('2020-05-29T13:28:36.000Z'),\n      field5: true,\n      createdAt: new Date('2021-08-18T02:36:06.549Z'),\n      updatedAt: new Date('2021-08-18T02:36:06.549Z'),\n    },\n  },\n  {\n    operation: OperationType.Set,\n    entityType: 'StarterEntity',\n    data: {\n      id: '0x2494bd5d089cf370c366351e851755ee42e8477df1c17ea1d9c2ae94e4f77ea8',\n      field3: null,\n      field1: 41914,\n      field2: null,\n      field4: new Date('2020-05-29T13:28:36.000Z'),\n      field5: true,\n      createdAt: new Date('2021-08-18T02:36:06.549Z'),\n      updatedAt: new Date('2021-08-18T02:36:06.549Z'),\n    },\n  },\n  {\n    operation: OperationType.Set,\n    entityType: 'StarterEntity',\n    data: {\n      id: '0x2494bd5d089cf370c366351e851755ee42e8477df1c17ea1d9c2ae94e4f77ea8',\n      field3: null,\n      field1: 41914,\n      field2: null,\n      field4: new Date('2020-05-29T13:28:36.000Z'),\n      field5: true,\n      field6: { meat: 0, fruit: { apple: 'Apple' } },\n      createdAt: new Date('2021-08-18T02:36:06.549Z'),\n      updatedAt: new Date('2021-08-18T02:36:06.549Z'),\n      field7: parseFloat('3.14'),\n      field8: 'Foo',\n    },\n  },\n  {\n    operation: OperationType.Remove,\n    entityType: 'StarterEntity',\n    data: '0x2494bd5d089cf370c366351e851755ee42e8477df1c17ea1d9c2ae94e4f77ea8',\n  },\n];\n\nconst falseOperation = {\n  operation: OperationType.Remove,\n  entityType: 'StarterEntity',\n  data: {\n    id: '0x2494bd5d089cf370c366351e851755ee42e8477df1c17ea1d9c2ae94e4f77ea8',\n    field3: null,\n    field1: 41914,\n    field2: null,\n    field4: new Date('2020-05-29T13:28:36.000Z'),\n    field5: true,\n    field6: { meat: 0, fruit: { apple: 'Apple' } },\n    createdAt: new Date('2021-08-18T02:36:06.549Z'),\n    updatedAt: new Date('2021-08-18T02:36:06.549Z'),\n    field7: parseFloat('3.14'),\n  },\n};\nconst apple: GraphQLJsonFieldType = {\n  name: 'apple',\n  type: 'String',\n  nullable: true,\n  isArray: false,\n};\nconst fruitJson: GraphQLJsonFieldType = {\n  name: 'fruit',\n  type: 'Json',\n  jsonInterface: { name: 'Fruit', fields: [apple] },\n  isArray: false,\n  nullable: true,\n};\nconst meatJson: GraphQLJsonFieldType = {\n  name: 'meat',\n  type: 'Int',\n  nullable: true,\n  isArray: false,\n};\nconst models = [\n  {\n    name: 'StarterEntity',\n    fields: [\n      {\n        name: 'id',\n        type: 'ID',\n        isArray: false,\n        nullable: false,\n        isEnum: false,\n      },\n      {\n        name: 'field1',\n        type: 'Int',\n        isArray: false,\n        nullable: false,\n        isEnum: false,\n      },\n      {\n        name: 'field2',\n        type: 'String',\n        isArray: false,\n        nullable: true,\n        isEnum: false,\n      },\n      {\n        name: 'field3',\n        type: 'BigInt',\n        isArray: false,\n        nullable: true,\n        isEnum: false,\n      },\n      {\n        name: 'field4',\n        type: 'Date',\n        isArray: false,\n        nullable: true,\n        isEnum: false,\n      },\n      {\n        name: 'field5',\n        type: 'Boolean',\n        isArray: false,\n        nullable: true,\n        isEnum: false,\n      },\n      {\n        name: 'field6',\n        type: 'Json',\n        jsonInterface: { name: 'Food', fields: [meatJson, fruitJson] },\n        isArray: false,\n        nullable: true,\n        isEnum: false,\n      },\n      {\n        name: 'field7',\n        type: 'Float',\n        isArray: false,\n        nullable: true,\n        isEnum: false,\n      },\n      {\n        type: 'TestEnum',\n        description: 'Field description',\n        isEnum: true,\n        isArray: false,\n        nullable: false,\n        name: 'field8',\n      },\n    ],\n    indexes: [],\n  },\n];\n\ndescribe('StoreOperations', () => {\n  it('put operation into the merkel leaf, and generate Merkle Root, also able to reset', () => {\n    const operationStack = new StoreOperations(models);\n    for (const o of testOperations) {\n      operationStack.put(o.operation, o.entityType, o.data);\n    }\n\n    operationStack.makeOperationMerkleTree();\n    expect(operationStack.getOperationLeafCount()).toBe(5);\n    console.log(\n      `Root in hex: ${u8aToHex(operationStack.getOperationMerkleRoot())}`,\n    );\n    operationStack.reset();\n    expect(operationStack.getOperationLeafCount()).toBe(0);\n  });\n\n  it('throw error when remove data is not string type', () => {\n    const operationStack = new StoreOperations(models);\n\n    expect(() =>\n      operationStack.put(\n        falseOperation.operation,\n        falseOperation.entityType,\n        falseOperation.data,\n      ),\n    ).toThrow(`Remove operation only accept data in string type`);\n  });\n});\n"]}