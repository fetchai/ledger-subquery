{"version":3,"file":"api.service.test.js","sourceRoot":"","sources":["../../src/indexer/api.service.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2020-2022 OnFinality Limited authors & contributors\n// SPDX-License-Identifier: Apache-2.0\n\nimport path from 'path';\nimport { fromAscii, toHex } from '@cosmjs/encoding';\nimport { Uint53 } from '@cosmjs/math';\nimport { toRfc3339WithNanoseconds } from '@cosmjs/tendermint-rpc';\nimport { INestApplication } from '@nestjs/common';\nimport { EventEmitterModule } from '@nestjs/event-emitter';\nimport { Test } from '@nestjs/testing';\nimport { loadFromJsonOrYaml } from '@subql/common';\nimport { GraphQLSchema } from 'graphql';\nimport { NodeConfig } from '../configure/NodeConfig';\nimport { SubqueryProject } from '../configure/SubqueryProject';\nimport { ApiService } from './api.service';\n\nconst ENDPOINT = 'https://rpc-juno.itastakers.com/';\nconst CHAINID = 'juno-1';\n\nconst TEST_BLOCKNUMBER = 3266772;\n\nconst projectsDir = path.join(__dirname, '../../test');\n\nfunction testCosmosProject(): SubqueryProject {\n  return {\n    network: {\n      endpoint: ENDPOINT,\n      chainId: CHAINID,\n    },\n    dataSources: [],\n    id: 'test',\n    root: './',\n    schema: new GraphQLSchema({}),\n    templates: [],\n  };\n}\n\njest.setTimeout(200000);\n\ndescribe.skip('ApiService', () => {\n  let app: INestApplication;\n  let apiService: ApiService;\n  const prepareApiService = async () => {\n    const module = await Test.createTestingModule({\n      providers: [\n        {\n          provide: SubqueryProject,\n          useFactory: () => testCosmosProject(),\n        },\n        ApiService,\n        NodeConfig,\n      ],\n      imports: [EventEmitterModule.forRoot()],\n    }).compile();\n    app = module.createNestApplication();\n    await app.init();\n    apiService = app.get(ApiService);\n    await apiService.init();\n  };\n\n  beforeAll(async () => {\n    await prepareApiService();\n  });\n\n  it('query block info', async () => {\n    const api = apiService.getApi();\n    const blockInfo = await api.blockInfo(TEST_BLOCKNUMBER);\n    const doc: any = loadFromJsonOrYaml(\n      path.join(projectsDir, 'block_3266772.json'),\n    );\n    const realBlockInfo = {\n      id: toHex(doc.block_id.hash).toUpperCase(),\n      header: {\n        version: {\n          block: new Uint53(+doc.block.header.version.block).toString(),\n          app: blockInfo.header.version.app,\n        },\n        height: doc.block.header.height,\n        chainId: doc.block.header.chainId,\n        time: toRfc3339WithNanoseconds(doc.block.header.time),\n      },\n      txs: doc.block.txs,\n    };\n    expect(blockInfo).toMatchObject(realBlockInfo);\n  });\n\n  it('query tx info by height', async () => {\n    const api = apiService.getApi();\n    const txInfos = await api.txInfoByHeight(TEST_BLOCKNUMBER);\n    expect(txInfos.length).toEqual(4);\n  });\n});\n"]}